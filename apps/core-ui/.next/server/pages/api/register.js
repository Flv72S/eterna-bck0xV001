"use strict";(()=>{var e={};e.id=553,e.ids=[553],e.modules={8432:e=>{e.exports=require("bcryptjs")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5900:e=>{e.exports=require("pg")},7612:e=>{e.exports=import("drizzle-orm")},1749:e=>{e.exports=import("drizzle-orm/node-postgres")},8358:e=>{e.exports=import("drizzle-orm/pg-core")},7673:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},8017:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>u,default:()=>c,routeModule:()=>d});var o=r(6205),i=r(4626),n=r(7673),l=r(2748),s=e([l]);l=(s.then?(await s)():s)[0];let c=(0,n.l)(l,"default"),u=(0,n.l)(l,"config"),d=new o.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/register",pathname:"/api/register",bundlePath:"",filename:""},userland:l});a()}catch(e){a(e)}})},4798:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{db:()=>c});var o=r(1749),i=r(5900),n=r(7136),l=e([o,n]);[o,n]=l.then?(await l)():l;let s=new i.Pool({connectionString:process.env.DATABASE_URL}),c=(0,o.drizzle)(s,{schema:n});a()}catch(e){a(e)}})},7136:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{pet_medical_records:()=>u,pets:()=>c,tokens:()=>s,users:()=>n,usersPro:()=>l});var o=r(8358),i=e([o]);o=(i.then?(await i)():i)[0];let n=(0,o.pgTable)("users",{id:(0,o.uuid)("id").defaultRandom().primaryKey(),email:(0,o.varchar)("email",{length:255}).notNull().unique(),pin:(0,o.text)("pin").notNull(),token:(0,o.text)("token"),version:(0,o.varchar)("version",{length:20}).default("free"),seriale_gioiello:(0,o.varchar)("seriale_gioiello",{length:100}),nome:(0,o.varchar)("nome",{length:100}),cognome:(0,o.varchar)("cognome",{length:100}),ruolo:(0,o.varchar)("ruolo",{length:30}).default("utente"),attivatore_validato:(0,o.boolean)("attivatore_validato").default(!1),nfc_supportato:(0,o.boolean)("nfc_supportato").default(!0),registrazione_via_nfc:(0,o.boolean)("registrazione_via_nfc").default(!1),otp:(0,o.varchar)("otp",{length:10}),otp_scadenza:(0,o.timestamp)("otp_scadenza"),verificato_email:(0,o.boolean)("verificato_email").default(!1),verificato_telefono:(0,o.boolean)("verificato_telefono").default(!1),ultima_login:(0,o.timestamp)("ultima_login").defaultNow(),created_at:(0,o.timestamp)("created_at").defaultNow(),updated_at:(0,o.timestamp)("updated_at").defaultNow()}),l=(0,o.pgTable)("users_pro",{user_id:(0,o.uuid)("user_id").primaryKey().references(()=>n.id),nome:(0,o.varchar)("nome",{length:100}).notNull(),cognome:(0,o.varchar)("cognome",{length:100}).notNull(),profession_type:(0,o.varchar)("profession_type",{length:100}).notNull(),specialization:(0,o.varchar)("specialization",{length:150}),business_name:(0,o.varchar)("business_name",{length:255}),vat_number:(0,o.varchar)("vat_number",{length:50}),address:(0,o.varchar)("address",{length:255}),city:(0,o.varchar)("city",{length:100}),region:(0,o.varchar)("region",{length:100}),cap:(0,o.varchar)("cap",{length:20}),website:(0,o.varchar)("website",{length:255}),license_number:(0,o.varchar)("license_number",{length:100}),license_country:(0,o.varchar)("license_country",{length:100}),license_verified:(0,o.boolean)("license_verified").default(!1),profile_image_url:(0,o.text)("profile_image_url"),approved_by_admin:(0,o.boolean)("approved_by_admin").default(!1),eterna_section:(0,o.varchar)("eterna_section",{length:100})}),s=(0,o.pgTable)("tokens",{id:(0,o.serial)("id").primaryKey(),user_id:(0,o.serial)("user_id").references(()=>n.id),token:(0,o.varchar)("token",{length:255}).notNull(),type:(0,o.varchar)("type",{length:50}).notNull(),expires_at:(0,o.timestamp)("expires_at").notNull(),created_at:(0,o.timestamp)("created_at").defaultNow().notNull()}),c=(0,o.pgTable)("pets",{id:(0,o.serial)("id").primaryKey(),user_id:(0,o.serial)("user_id").references(()=>n.id),name:(0,o.varchar)("name",{length:255}).notNull(),type:(0,o.varchar)("type",{length:50}).notNull(),breed:(0,o.varchar)("breed",{length:255}),birth_date:(0,o.timestamp)("birth_date"),created_at:(0,o.timestamp)("created_at").defaultNow().notNull(),updated_at:(0,o.timestamp)("updated_at").defaultNow().notNull()}),u=(0,o.pgTable)("pet_medical_records",{id:(0,o.serial)("id").primaryKey(),pet_id:(0,o.serial)("pet_id").references(()=>c.id),record_type:(0,o.varchar)("record_type",{length:50}).notNull(),description:(0,o.text)("description"),date:(0,o.timestamp)("date").notNull(),created_at:(0,o.timestamp)("created_at").defaultNow().notNull()});a()}catch(e){a(e)}})},2748:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{default:()=>c});var o=r(8432),i=r(4798),n=r(7136),l=r(7612),s=e([i,n,l]);async function c(e,t){if(t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","POST, OPTIONS"),t.setHeader("Access-Control-Allow-Headers","Content-Type"),"OPTIONS"===e.method)return t.status(200).json({});if("POST"!==e.method)return t.status(405).json({error:"Metodo non consentito"});try{let{email:r,pin:a,token:s,version:c,seriale_gioiello:u,nome:d,cognome:p,nfc_supportato:m=!0,registrazione_via_nfc:_=!1}=e.body;if(!r||!a)return t.status(400).json({error:"Email e PIN sono obbligatori"});if(await i.db.query.users.findFirst({where:(0,l.eq)(n.users.email,r)}))return t.status(400).json({error:"Email gi\xe0 registrata"});if("premium"===c&&!u)return t.status(400).json({error:"Il numero seriale del gioiello \xe8 obbligatorio per gli utenti premium"});let h=await (0,o.hash)(a,10),[f]=await i.db.insert(n.users).values({email:r,pin:h,token:s,version:c||"free",seriale_gioiello:"premium"===c?u:null,nome:d,cognome:p,nfc_supportato:m,registrazione_via_nfc:_,attivatore_validato:!1,verificato_email:!1,verificato_telefono:!1}).returning();return t.status(201).json({success:!0,message:"Registrazione completata con successo",user:{id:f.id,email:f.email,nome:f.nome,cognome:f.cognome,version:f.version,nfc_supportato:f.nfc_supportato,verificato_email:f.verificato_email,verificato_telefono:f.verificato_telefono}})}catch(e){return console.error("Errore durante la registrazione:",e),t.status(500).json({error:"Errore interno del server",details:e instanceof Error?e.message:"Errore sconosciuto"})}}[i,n,l]=s.then?(await s)():s,a()}catch(e){a(e)}})},4626:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},6205:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=8017);module.exports=r})();